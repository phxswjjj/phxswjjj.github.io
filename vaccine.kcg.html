<html>

<head>
    <style>
        #req-fail img {
            border: 2px solid black;
        }

        #txtName {
            width: 14em;
        }
    </style>
</head>

<body>
    <div id="root">
        <div>
            <a href="https://vaccine.kcg.gov.tw/Reserve" target="_blank">高雄市新冠肺炎疫苗接種預約系統</a>
        </div>
        <hr />
        <div id="condition">
            <div>
                <span>名稱(like):</span><input id="txtName" type="text" list="nameOptions" value="莫德納" />
                <datalist id="nameOptions">
                </datalist>
            </div>
            <div style="margin-top: .5em;">
                <input id="btnQuery" type="button" onclick="LoadData(this)" value="Query" />
            </div>
        </div>
        <hr />
        <div id="content"></div>
    </div>
    <div id="req-fail" style="display: none;">
        <p>
            如看到此訊息，請至底下連結執行「Request temporary access to then demo server」暫時啟用跨站請求。
        </p>
        <p>
            <a href="https://cors-anywhere.herokuapp.com/corsdemo"
                target="_blank">https://cors-anywhere.herokuapp.com/corsdemo</a>
        </p>
        <a href="https://cors-anywhere.herokuapp.com/corsdemo" target="_blank"><img
                src="images/cors-anywhere-corsdemo.jpg" /></a>
    </div>
    <script>
        const corsUrl = 'https://cors-anywhere.herokuapp.com/';

        function LoadSetting() {
            let prevName = localStorage.getItem('query-name');
            if (prevName)
                document.querySelector('#txtName').value = prevName;
        }

        function ShowCORSError() {
            let root = document.querySelector('#root');
            root.style.display = 'none';

            let reqFail = document.querySelector('#req-fail');
            reqFail.style.display = 'block';

            setTimeout(() => {
                window.location.reload();
            }, 5000);
        }

        function DataComparer(x, y) {
            let t = x.town.localeCompare(y.town);
            if (t == 0)
                t = x.name.localeCompare(y.name);
            return t;
        }

        function LoadData(el) {
            if (el) {
                let queryName = document.querySelector('#txtName').value;
                if (queryName)
                    localStorage.setItem('query-name', queryName);
            }
            if (!el) el = document.querySelector('#btnQuery');
            el.disabled = true;

            let content = document.querySelector('#content');
            content.innerText = 'loading...';

            let url = 'https://vaccine.kcg.gov.tw/api/Common/HealthCenters?town=';
            let options = {};
            fetch(`${corsUrl}${url}`, options)
                .then(resp => {
                    if (!resp.ok)
                        throw {
                            message: resp.statusText,
                            status: resp.status
                        };

                    // 轉 json
                    return resp.json();
                })
                .then(list => {
                    //處理 name list
                    let names = list
                        .map(d => d.name.split('，')[1])
                        .filter((item, index, self) => {
                            return self.indexOf(item) === index;
                        })
                        .sort((x, y) => x.localeCompare(y));

                    let nameOptions = document.querySelector('#nameOptions');
                    nameOptions.innerHTML = '';
                    names.forEach(name => {
                        let opt = document.createElement('option');
                        opt.value = name;
                        nameOptions.appendChild(opt);
                    });
                    return list;
                })
                .then(list => {
                    // 排序
                    list.sort(DataComparer);
                    return list;
                })
                .then(list => {
                    // 篩選
                    content.innerHTML = '';
                    let likeName = txtName.value;

                    list.forEach((data) => {
                        if (likeName && !data.name.includes(likeName)) return;

                        let found = data.servicePeriods.find(s => !s.isFull);
                        if (!found) return;

                        let totalNum = data.servicePeriods
                            .map(x => x.maximum)
                            .reduce((x, y) => {
                                if (!x) return y;
                                if (!y) return x;
                                return x + y;
                            });
                        let curNum = data.servicePeriods
                            .map(x => x.current)
                            .reduce((x, y) => {
                                if (!x) return y;
                                if (!y) return x;
                                return x + y;
                            });

                        let remaining = totalNum - curNum;

                        let place = document.createElement('div');
                        place.innerHTML = `${data.town}-${data.name}, 剩餘名額：${remaining}`;
                        content.appendChild(place);
                    });

                    el.disabled = false;
                })
                .catch(ex => {
                    console.log('error', ex.message);
                    content.innerText = ex.message;

                    if (ex.status == 403) {
                        ShowCORSError();
                    }
                });
        }

        LoadSetting();
        LoadData();
    </script>
</body>

</html>